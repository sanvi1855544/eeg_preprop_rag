<h1 id="wsgi-helpers">WSGI Helpers</h1> <p>The following classes and functions are designed to make working with the WSGI specification easier or operate on the WSGI layer. All the functionality from this module is available on the high-level <a class="reference internal" href="../wrappers/index"><span class="doc">Request / Response Objects</span></a>.</p> <section id="iterator-stream-helpers"> <h2>Iterator / Stream Helpers</h2> <p>These classes and functions simplify working with the WSGI application iterator and the input stream.</p> <dl class="py class"> <dt class="sig sig-object py" id="werkzeug.wsgi.ClosingIterator">
<code>class werkzeug.wsgi.ClosingIterator(iterable, callbacks=None)</code> </dt> <dd>
<p>The WSGI specification requires that all middlewares and gateways respect the <code>close</code> callback of the iterable returned by the application. Because it is useful to add another close action to a returned iterable and adding a custom iterable is a boring task this class can be used for that:</p> <pre data-language="python">return ClosingIterator(app(environ, start_response), [cleanup_session,
                                                      cleanup_locals])
</pre> <p>If there is just one close function it can be passed instead of the list.</p> <p>A closing iterator is not needed if the application uses response objects and finishes the processing if the response is started:</p> <pre data-language="python">try:
    return response(environ, start_response)
finally:
    cleanup_session()
    cleanup_locals()
</pre> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>iterable</strong> (<em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a><em>]</em>) – </li> <li>
<strong>callbacks</strong> (<em>Optional</em><em>[</em><em>Union</em><em>[</em><em>Callable</em><em>[</em><em>[</em><em>]</em><em>, </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a><em>]</em><em>, </em><em>Iterable</em><em>[</em><em>Callable</em><em>[</em><em>[</em><em>]</em><em>, </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a><em>]</em><em>]</em><em>]</em><em>]</em>) – </li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a></p> </dd> </dl> </dd>
</dl> <dl class="py class"> <dt class="sig sig-object py" id="werkzeug.wsgi.FileWrapper">
<code>class werkzeug.wsgi.FileWrapper(file, buffer_size=8192)</code> </dt> <dd>
<p>This class can be used to convert a <code>file</code>-like object into an iterable. It yields <code>buffer_size</code> blocks until the file is fully read.</p> <p>You should not use this class directly but rather use the <a class="reference internal" href="#werkzeug.wsgi.wrap_file" title="werkzeug.wsgi.wrap_file"><code>wrap_file()</code></a> function that uses the WSGI server’s file wrapper support if it’s available.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.5.</span></p> </div> </details><p>If you’re using this object together with a <code>Response</code> you have to use the <code>direct_passthrough</code> mode.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>file</strong> (<em>BinaryIO</em>) – a <code>file</code>-like object with a <code>read()</code> method.</li> <li>
<strong>buffer_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – number of bytes for one iteration.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a></p> </dd> </dl> </dd>
</dl> <dl class="py class"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream">
<code>class werkzeug.wsgi.LimitedStream(stream, limit)</code> </dt> <dd>
<p>Wraps a stream so that it doesn’t read more than n bytes. If the stream is exhausted and the caller tries to get more bytes from it <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.on_exhausted" title="werkzeug.wsgi.LimitedStream.on_exhausted"><code>on_exhausted()</code></a> is called which by default returns an empty string. The return value of that function is forwarded to the reader function. So if it returns an empty string <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.read" title="werkzeug.wsgi.LimitedStream.read"><code>read()</code></a> will return an empty string as well.</p> <p>The limit however must never be higher than what the stream can output. Otherwise <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readlines" title="werkzeug.wsgi.LimitedStream.readlines"><code>readlines()</code></a> will try to read past the limit.</p> <div class="admonition-note-on-wsgi-compliance admonition"> <p class="admonition-title">Note on WSGI compliance</p> <p>calls to <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readline" title="werkzeug.wsgi.LimitedStream.readline"><code>readline()</code></a> and <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readlines" title="werkzeug.wsgi.LimitedStream.readlines"><code>readlines()</code></a> are not WSGI compliant because it passes a size argument to the readline methods. Unfortunately the WSGI PEP is not safely implementable without a size argument to <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readline" title="werkzeug.wsgi.LimitedStream.readline"><code>readline()</code></a> because there is no EOF marker in the stream. As a result of that the use of <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readline" title="werkzeug.wsgi.LimitedStream.readline"><code>readline()</code></a> is discouraged.</p> <p>For the same reason iterating over the <a class="reference internal" href="#werkzeug.wsgi.LimitedStream" title="werkzeug.wsgi.LimitedStream"><code>LimitedStream</code></a> is not portable. It internally calls <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readline" title="werkzeug.wsgi.LimitedStream.readline"><code>readline()</code></a>.</p> <p>We strongly suggest using <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.read" title="werkzeug.wsgi.LimitedStream.read"><code>read()</code></a> only or using the <a class="reference internal" href="#werkzeug.wsgi.make_line_iter" title="werkzeug.wsgi.make_line_iter"><code>make_line_iter()</code></a> which safely iterates line-based over a WSGI input stream.</p> </div> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>stream</strong> (<em>BinaryIO</em>) – the stream to wrap.</li> <li>
<strong>limit</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – the limit for the stream, must not be longer than what the string can provide if the stream does not end with <code>EOF</code> (like <code>wsgi.input</code>)</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a></p> </dd> </dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.exhaust">
<code>exhaust(chunk_size=65536)</code> </dt> <dd>
<p>Exhaust the stream. This consumes all the data left until the limit is reached.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>chunk_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – the size for a chunk. It will read the chunk until the stream is exhausted and throw away the results.</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.9)">None</a></p> </dd> </dl> </dd>
</dl> <dl class="py property"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.is_exhausted">
<code>property is_exhausted: bool</code> </dt> <dd>
<p>If the stream is exhausted this attribute is <code>True</code>.</p> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.on_disconnect">
<code>on_disconnect()</code> </dt> <dd>
<p>What should happen if a disconnect is detected? The return value of this function is returned from read functions in case the client went away. By default a <a class="reference internal" href="../exceptions/index#werkzeug.exceptions.ClientDisconnected" title="werkzeug.exceptions.ClientDisconnected"><code>ClientDisconnected</code></a> exception is raised.</p> <dl class="field-list simple"> <dt class="field-odd">Return type</dt> <dd class="field-odd">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a></p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.on_exhausted">
<code>on_exhausted()</code> </dt> <dd>
<p>This is called when the stream tries to read past the limit. The return value of this function is returned from the reading function.</p> <dl class="field-list simple"> <dt class="field-odd">Return type</dt> <dd class="field-odd">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a></p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.read">
<code>read(size=None)</code> </dt> <dd>
<p>Read <code>size</code> bytes or if size is not provided everything is read.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>size</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><em>]</em>) – the number of bytes read.</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a></p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.readable">
<code>readable()</code> </dt> <dd>
<p>Return whether object was opened for reading.</p> <p>If False, read() will raise OSError.</p> <dl class="field-list simple"> <dt class="field-odd">Return type</dt> <dd class="field-odd">
<p><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a></p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.readline">
<code>readline(size=None)</code> </dt> <dd>
<p>Reads one line from the stream.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>size</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><em>]</em>) – </p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a></p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.readlines">
<code>readlines(size=None)</code> </dt> <dd>
<p>Reads a file into a list of strings. It calls <a class="reference internal" href="#werkzeug.wsgi.LimitedStream.readline" title="werkzeug.wsgi.LimitedStream.readline"><code>readline()</code></a> until the file is read to the end. It does support the optional <code>size</code> argument if the underlying stream supports it for <code>readline</code>.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>size</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><em>]</em>) – </p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>List[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py method"> <dt class="sig sig-object py" id="werkzeug.wsgi.LimitedStream.tell">
<code>tell()</code> </dt> <dd>
<p>Returns the position of the stream.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Return type</dt> <dd class="field-odd">
<p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a></p> </dd> </dl> </dd>
</dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.make_line_iter">
<code>werkzeug.wsgi.make_line_iter(stream, limit=None, buffer_size=10240, cap_at_buffer=False)</code> </dt> <dd>
<p>Safely iterates line-based over an input stream. If the input stream is not a <a class="reference internal" href="#werkzeug.wsgi.LimitedStream" title="werkzeug.wsgi.LimitedStream"><code>LimitedStream</code></a> the <code>limit</code> parameter is mandatory.</p> <p>This uses the stream’s <code>read()</code> method internally as opposite to the <code>readline()</code> method that is unsafe and can only be used in violation of the WSGI specification. The same problem applies to the <code>__iter__</code> function of the input stream which calls <code>readline()</code> without arguments.</p> <p>If you need line-by-line processing it’s strongly recommended to iterate over the input stream using this helper function.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.11.10: </span>added support for the <code>cap_at_buffer</code> parameter.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.9: </span>added support for iterators as input stream.</p> </div> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 0.8: </span>This function now ensures that the limit was reached.</p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>stream</strong> (<em>Union</em><em>[</em><em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a><em>]</em><em>, </em><em>BinaryIO</em><em>]</em>) – the stream or iterate to iterate over.</li> <li>
<strong>limit</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><em>]</em>) – the limit in bytes for the stream. (Usually content length. Not necessary if the <code>stream</code> is a <a class="reference internal" href="#werkzeug.wsgi.LimitedStream" title="werkzeug.wsgi.LimitedStream"><code>LimitedStream</code></a>.</li> <li>
<strong>buffer_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – The optional buffer size.</li> <li>
<strong>cap_at_buffer</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – if this is set chunks are split if they are longer than the buffer size. Internally this is implemented that the buffer size might be exhausted by a factor of two however.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Iterator[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.make_chunk_iter">
<code>werkzeug.wsgi.make_chunk_iter(stream, separator, limit=None, buffer_size=10240, cap_at_buffer=False)</code> </dt> <dd>
<p>Works like <a class="reference internal" href="#werkzeug.wsgi.make_line_iter" title="werkzeug.wsgi.make_line_iter"><code>make_line_iter()</code></a> but accepts a separator which divides chunks. If you want newline based processing you should use <a class="reference internal" href="#werkzeug.wsgi.make_line_iter" title="werkzeug.wsgi.make_line_iter"><code>make_line_iter()</code></a> instead as it supports arbitrary newline markers.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.11.10: </span>added support for the <code>cap_at_buffer</code> parameter.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.9: </span>added support for iterators as input stream.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.8.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>stream</strong> (<em>Union</em><em>[</em><em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a><em>]</em><em>, </em><em>BinaryIO</em><em>]</em>) – the stream or iterate to iterate over.</li> <li>
<strong>separator</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>) – the separator that divides chunks.</li> <li>
<strong>limit</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><em>]</em>) – the limit in bytes for the stream. (Usually content length. Not necessary if the <code>stream</code> is otherwise already limited).</li> <li>
<strong>buffer_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – The optional buffer size.</li> <li>
<strong>cap_at_buffer</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – if this is set chunks are split if they are longer than the buffer size. Internally this is implemented that the buffer size might be exhausted by a factor of two however.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Iterator[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.wrap_file">
<code>werkzeug.wsgi.wrap_file(environ, file, buffer_size=8192)</code> </dt> <dd>
<p>Wraps a file. This uses the WSGI server’s file wrapper if available or otherwise the generic <a class="reference internal" href="#werkzeug.wsgi.FileWrapper" title="werkzeug.wsgi.FileWrapper"><code>FileWrapper</code></a>.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.5.</span></p> </div> </details><p>If the file wrapper from the WSGI server is used it’s important to not iterate over it from inside the application but to pass it through unchanged. If you want to pass out a file wrapper inside a response object you have to set <code>Response.direct_passthrough</code> to <code>True</code>.</p> <p>More information about file wrappers are available in <a class="pep reference external" href="https://www.python.org/dev/peps/pep-0333" id="index-0"><strong>PEP 333</strong></a>.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>file</strong> (<em>BinaryIO</em>) – a <code>file</code>-like object with a <code>read()</code> method.</li> <li>
<strong>buffer_size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>) – number of bytes for one iteration.</li> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – </li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Iterable[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>]</p> </dd> </dl> </dd>
</dl> </section> <section id="environ-helpers"> <h2>Environ Helpers</h2> <p>These functions operate on the WSGI environment. They extract useful information or perform common manipulations:</p> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_host">
<code>werkzeug.wsgi.get_host(environ, trusted_hosts=None)</code> </dt> <dd>
<p>Return the host for the given WSGI environment.</p> <p>The <code>Host</code> header is preferred, then <code>SERVER_NAME</code> if it’s not set. The returned host will only contain the port if it is different than the standard port for the protocol.</p> <p>Optionally, verify that the host is trusted using <a class="reference internal" href="#werkzeug.wsgi.host_is_trusted" title="werkzeug.wsgi.host_is_trusted"><code>host_is_trusted()</code></a> and raise a <a class="reference internal" href="../exceptions/index#werkzeug.exceptions.SecurityError" title="werkzeug.exceptions.SecurityError"><code>SecurityError</code></a> if it is not.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – A WSGI environment dict.</li> <li>
<strong>trusted_hosts</strong> (<em>Optional</em><em>[</em><em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><em>]</em><em>]</em>) – A list of trusted host names.</li> </ul> </dd> <dt class="field-even">Returns</dt> <dd class="field-even">
<p>Host, with port if necessary.</p> </dd> <dt class="field-odd">Raises</dt> <dd class="field-odd">
<p><a class="reference internal" href="../exceptions/index#werkzeug.exceptions.SecurityError" title="werkzeug.exceptions.SecurityError"><strong>SecurityError</strong></a> – If the host is not trusted.</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_content_length">
<code>werkzeug.wsgi.get_content_length(environ)</code> </dt> <dd>
<p>Returns the content length from the WSGI environment as integer. If it’s not available or chunked transfer encoding is used, <code>None</code> is returned.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>environ</strong> (<em>WSGIEnvironment</em>) – the WSGI environ to fetch the content length from.</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Optional[<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_input_stream">
<code>werkzeug.wsgi.get_input_stream(environ, safe_fallback=True)</code> </dt> <dd>
<p>Returns the input stream from the WSGI environment and wraps it in the most sensible way possible. The stream returned is not the raw WSGI stream in most cases but one that is safe to read from without taking into account the content length.</p> <p>If content length is not set, the stream will be empty for safety reasons. If the WSGI server supports chunked or infinite streams, it should set the <code>wsgi.input_terminated</code> value in the WSGI environ to indicate that.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – the WSGI environ to fetch the stream from.</li> <li>
<strong>safe_fallback</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – use an empty stream as a safe fallback when the content length is not set. Disabling this allows infinite streams, which can be a denial-of-service risk.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>BinaryIO</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_current_url">
<code>werkzeug.wsgi.get_current_url(environ, root_only=False, strip_querystring=False, host_only=False, trusted_hosts=None)</code> </dt> <dd>
<p>Recreate the URL for a request from the parts in a WSGI environment.</p> <p>The URL is an IRI, not a URI, so it may contain Unicode characters. Use <a class="reference internal" href="../urls/index#werkzeug.urls.iri_to_uri" title="werkzeug.urls.iri_to_uri"><code>iri_to_uri()</code></a> to convert it to ASCII.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – The WSGI environment to get the URL parts from.</li> <li>
<strong>root_only</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – Only build the root path, don’t include the remaining path or query string.</li> <li>
<strong>strip_querystring</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – Don’t include the query string.</li> <li>
<strong>host_only</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – Only build the scheme and host.</li> <li>
<strong>trusted_hosts</strong> (<em>Optional</em><em>[</em><em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><em>]</em><em>]</em>) – A list of trusted host names to validate the host against.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_query_string">
<code>werkzeug.wsgi.get_query_string(environ)</code> </dt> <dd>
<p>Returns the <code>QUERY_STRING</code> from the WSGI environment. This also takes care of the WSGI decoding dance. The string returned will be restricted to ASCII characters.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>environ</strong> (<em>WSGIEnvironment</em>) – WSGI environment to get the query string from.</p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></p> </dd> </dl> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details>
</dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_script_name">
<code>werkzeug.wsgi.get_script_name(environ, charset='utf-8', errors='replace')</code> </dt> <dd>
<p>Return the <code>SCRIPT_NAME</code> from the WSGI environment and decode it unless <code>charset</code> is set to <code>None</code>.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – WSGI environment to get the path from.</li> <li>
<strong>charset</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The charset for the path, or <code>None</code> if no decoding should be performed.</li> <li>
<strong>errors</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The decoding error handling.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></p> </dd> </dl> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details>
</dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.get_path_info">
<code>werkzeug.wsgi.get_path_info(environ, charset='utf-8', errors='replace')</code> </dt> <dd>
<p>Return the <code>PATH_INFO</code> from the WSGI environment and decode it unless <code>charset</code> is <code>None</code>.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – WSGI environment to get the path from.</li> <li>
<strong>charset</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The charset for the path info, or <code>None</code> if no decoding should be performed.</li> <li>
<strong>errors</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The decoding error handling.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></p> </dd> </dl> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details>
</dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.pop_path_info">
<code>werkzeug.wsgi.pop_path_info(environ, charset='utf-8', errors='replace')</code> </dt> <dd>
<p>Removes and returns the next segment of <code>PATH_INFO</code>, pushing it onto <code>SCRIPT_NAME</code>. Returns <code>None</code> if there is nothing left on <code>PATH_INFO</code>.</p> <p>If the <code>charset</code> is set to <code>None</code> bytes are returned.</p> <p>If there are empty segments (<code>'/foo//bar</code>) these are ignored but properly pushed to the <code>SCRIPT_NAME</code>:</p> <pre data-language="python">&gt;&gt;&gt; env = {'SCRIPT_NAME': '/foo', 'PATH_INFO': '/a/b'}
&gt;&gt;&gt; pop_path_info(env)
'a'
&gt;&gt;&gt; env['SCRIPT_NAME']
'/foo/a'
&gt;&gt;&gt; pop_path_info(env)
'b'
&gt;&gt;&gt; env['SCRIPT_NAME']
'/foo/a/b'
</pre> <details class="changelog"> <summary>Changelog</summary><div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 0.9: </span>The path is now decoded and a charset and encoding parameter can be provided.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.5.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – the WSGI environment that is modified.</li> <li>
<strong>charset</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The <code>encoding</code> parameter passed to <code>bytes.decode()</code>.</li> <li>
<strong>errors</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The <code>errors</code> paramater passed to <code>bytes.decode()</code>.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Optional[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.peek_path_info">
<code>werkzeug.wsgi.peek_path_info(environ, charset='utf-8', errors='replace')</code> </dt> <dd>
<p>Returns the next segment on the <code>PATH_INFO</code> or <code>None</code> if there is none. Works like <a class="reference internal" href="#werkzeug.wsgi.pop_path_info" title="werkzeug.wsgi.pop_path_info"><code>pop_path_info()</code></a> without modifying the environment:</p> <pre data-language="python">&gt;&gt;&gt; env = {'SCRIPT_NAME': '/foo', 'PATH_INFO': '/a/b'}
&gt;&gt;&gt; peek_path_info(env)
'a'
&gt;&gt;&gt; peek_path_info(env)
'a'
</pre> <p>If the <code>charset</code> is set to <code>None</code> bytes are returned.</p> <details class="changelog"> <summary>Changelog</summary><div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 0.9: </span>The path is now decoded and a charset and encoding parameter can be provided.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.5.</span></p> </div> </details><dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – the WSGI environment that is checked.</li> <li>
<strong>charset</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – </li> <li>
<strong>errors</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – </li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Optional[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>]</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.extract_path_info">
<code>werkzeug.wsgi.extract_path_info(environ_or_baseurl, path_or_url, charset='utf-8', errors='werkzeug.url_quote', collapse_http_schemes=True)</code> </dt> <dd>
<p>Extracts the path info from the given URL (or WSGI environment) and path. The path info returned is a string. The URLs might also be IRIs.</p> <p>If the path info could not be determined, <code>None</code> is returned.</p> <p>Some examples:</p> <pre data-language="python">&gt;&gt;&gt; extract_path_info('http://example.com/app', '/app/hello')
'/hello'
&gt;&gt;&gt; extract_path_info('http://example.com/app',
...                   'https://example.com/app/hello')
'/hello'
&gt;&gt;&gt; extract_path_info('http://example.com/app',
...                   'https://example.com/app/hello',
...                   collapse_http_schemes=False) is None
True
</pre> <p>Instead of providing a base URL you can also pass a WSGI environment.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ_or_baseurl</strong> (<em>Union</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><em>, </em><em>WSGIEnvironment</em><em>]</em>) – a WSGI environment dict, a base URL or base IRI. This is the root of the application.</li> <li>
<strong>path_or_url</strong> (<em>Union</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><em>, </em><em>werkzeug.urls._URLTuple</em><em>]</em>) – an absolute path from the server root, a relative path (in which case it’s the path info) or a full URL.</li> <li>
<strong>charset</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – the charset for byte data in URLs</li> <li>
<strong>errors</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – the error handling on decode</li> <li>
<strong>collapse_http_schemes</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a>) – if set to <code>False</code> the algorithm does not assume that http and https on the same server point to the same resource.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Optional[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>]</p> </dd> </dl> <details class="changelog"> <summary>Changelog</summary><div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 0.15: </span>The <code>errors</code> parameter defaults to leaving invalid bytes quoted instead of replacing them.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 0.6.</span></p> </div> </details>
</dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.host_is_trusted">
<code>werkzeug.wsgi.host_is_trusted(hostname, trusted_list)</code> </dt> <dd>
<p>Check if a host matches a list of trusted names.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>hostname</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a>) – The name to check.</li> <li>
<strong>trusted_list</strong> (<em>Iterable</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><em>]</em>) – A list of valid names to match. If a name starts with a dot it will match all subdomains.</li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.9)">bool</a></p> </dd> </dl> <details class="changelog"> <summary>Changelog</summary><div class="versionadded"> <p><span class="versionmodified added">New in version 0.9.</span></p> </div> </details>
</dd>
</dl> </section> <section id="convenience-helpers"> <h2>Convenience Helpers</h2> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.wsgi.responder">
<code>werkzeug.wsgi.responder(f)</code> </dt> <dd>
<p>Marks a function as responder. Decorate a function with it and it will automatically call the return value as WSGI application.</p> <p>Example:</p> <pre data-language="python">@responder
def application(environ, start_response):
    return Response('Hello World!')
</pre> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<p><strong>f</strong> (<em>Callable</em><em>[</em><em>[</em><em>...</em><em>]</em><em>, </em><em>WSGIApplication</em><em>]</em>) – </p> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>WSGIApplication</p> </dd> </dl> </dd>
</dl> <dl class="py function"> <dt class="sig sig-object py" id="werkzeug.testapp.test_app">
<code>werkzeug.testapp.test_app(environ, start_response)</code> </dt> <dd>
<p>Simple test application that dumps the environment. You can use it to check if Werkzeug is working properly:</p> <pre data-language="pycon">&gt;&gt;&gt; from werkzeug.serving import run_simple
&gt;&gt;&gt; from werkzeug.testapp import test_app
&gt;&gt;&gt; run_simple('localhost', 3000, test_app)
 * Running on http://localhost:3000/
</pre> <p>The application displays important information from the WSGI environment, the Python interpreter and the installed libraries.</p> <dl class="field-list simple"> <dt class="field-odd">Parameters</dt> <dd class="field-odd">
<ul class="simple"> <li>
<strong>environ</strong> (<em>WSGIEnvironment</em>) – </li> <li>
<strong>start_response</strong> (<em>StartResponse</em>) – </li> </ul> </dd> <dt class="field-even">Return type</dt> <dd class="field-even">
<p>Iterable[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.9)">bytes</a>]</p> </dd> </dl> </dd>
</dl> </section> <section id="bytes-strings-and-encodings"> <h2>Bytes, Strings, and Encodings</h2> <p>The values in HTTP requests come in as bytes representing (or encoded to) ASCII. The WSGI specification (<a class="pep reference external" href="https://www.python.org/dev/peps/pep-3333" id="index-1"><strong>PEP 3333</strong></a>) decided to always use the <code>str</code> type to represent values. To accomplish this, the raw bytes are decoded using the ISO-8859-1 charset to produce a string.</p> <p>Strings in the WSGI environment are restricted to ISO-8859-1 code points. If a string read from the environment might contain characters outside that charset, it must first be decoded to bytes as ISO-8859-1, then encoded to a string using the proper charset (typically UTF-8). The reverse is done when writing to the environ. This is known as the “WSGI encoding dance”.</p> <p>Werkzeug provides functions to deal with this automatically so that you don’t need to be aware of the inner workings. Use the functions on this page as well as <a class="reference internal" href="../datastructures/index#werkzeug.datastructures.EnvironHeaders" title="werkzeug.datastructures.EnvironHeaders"><code>EnvironHeaders()</code></a> to read data out of the WSGI environment.</p> <p>Applications should avoid manually creating or modifying a WSGI environment unless they take care of the proper encoding or decoding step. All high level interfaces in Werkzeug will apply the encoding and decoding as necessary.</p> </section> <section id="raw-request-uri-and-path-encoding"> <h2>Raw Request URI and Path Encoding</h2> <p>The <code>PATH_INFO</code> in the environ is the path value after percent-decoding. For example, the raw path <code>/hello%2fworld</code> would show up from the WSGI server to Werkzeug as <code>/hello/world</code>. This loses the information that the slash was a raw character as opposed to a path separator.</p> <p>The WSGI specification (<a class="pep reference external" href="https://www.python.org/dev/peps/pep-3333" id="index-2"><strong>PEP 3333</strong></a>) does not provide a way to get the original value, so it is impossible to route some types of data in the path. The most compatible way to work around this is to send problematic data in the query string instead of the path.</p> <p>However, many WSGI servers add a non-standard environ key with the raw path. To match this behavior, Werkzeug’s test client and development server will add the raw value to both the <code>REQUEST_URI</code> and <code>RAW_URI</code> keys. If you want to route based on this value, you can use middleware to replace <code>PATH_INFO</code> in the environ before it reaches the application. However, keep in mind that these keys are non-standard and not guaranteed to be present.</p> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2007&ndash;2021 Pallets<br>Licensed under the BSD 3-clause License.<br>
    <a href="https://werkzeug.palletsprojects.com/en/2.0.x/wsgi/" class="_attribution-link">https://werkzeug.palletsprojects.com/en/2.0.x/wsgi/</a>
  </p>
</div>
